<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Crypto Chart Analyzer</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://unpkg.com/lightweight-charts@4.0.0/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #1e3a8a 0%, #3730a3 50%, #581c87 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        .glass-morphism {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.25);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }
        
        .chart-container {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.15), 0 10px 10px -5px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.4);
        }
        
        .alert-container {
            max-height: 350px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: rgba(139, 92, 246, 0.6) transparent;
        }
        
        .alert-container::-webkit-scrollbar {
            width: 6px;
        }
        
        .alert-container::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .alert-container::-webkit-scrollbar-thumb {
            background: rgba(139, 92, 246, 0.6);
            border-radius: 3px;
        }
        
        .signal-indicator {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.05); }
        }
        
        @keyframes glow {
            0%, 100% { box-shadow: 0 0 8px rgba(139, 92, 246, 0.6); }
            50% { box-shadow: 0 0 25px rgba(139, 92, 246, 0.9), 0 0 35px rgba(139, 92, 246, 0.7); }
        }
        
        .confluence-signal {
            border-left: 5px solid #8b5cf6;
            background: linear-gradient(90deg, rgba(139, 92, 246, 0.15) 0%, rgba(139, 92, 246, 0.08) 100%);
            animation: glow 3s ease-in-out infinite;
            color: #ffffff !important;
            font-weight: 600;
        }
        
        .long-signal {
            border-left: 5px solid #10b981;
            background: linear-gradient(90deg, rgba(16, 185, 129, 0.15) 0%, rgba(16, 185, 129, 0.08) 100%);
            color: #ffffff !important;
            font-weight: 600;
        }
        
        .short-signal {
            border-left: 5px solid #ef4444;
            background: linear-gradient(90deg, rgba(239, 68, 68, 0.15) 0%, rgba(239, 68, 68, 0.08) 100%);
            color: #ffffff !important;
            font-weight: 600;
        }
        
        .timeframe-alert {
            border-left: 5px solid #f59e0b;
            background: linear-gradient(90deg, rgba(245, 158, 11, 0.15) 0%, rgba(245, 158, 11, 0.08) 100%);
            color: #ffffff !important;
            font-weight: 600;
        }
        
        .timeframe-status {
            font-size: 10px;
            padding: 5px 9px;
            border-radius: 8px;
            margin: 2px;
            display: inline-block;
            min-width: 42px;
            text-align: center;
            font-weight: 700;
            transition: all 0.3s ease;
            box-shadow: 0 3px 6px rgba(0,0,0,0.15);
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .tf-loading { 
            background: linear-gradient(135deg, #6b7280, #4b5563); 
            color: #ffffff; 
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }
        
        .tf-oversold { 
            background: linear-gradient(135deg, #10b981, #059669); 
            color: #ffffff;
            animation: pulse 2s infinite;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }
        
        .tf-overbought { 
            background: linear-gradient(135deg, #ef4444, #dc2626); 
            color: #ffffff;
            animation: pulse 2s infinite;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }
        
        .tf-neutral { 
            background: linear-gradient(135deg, #64748b, #475569); 
            color: #ffffff; 
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }
        
        .alert-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: bold;
            margin-left: 10px;
            box-shadow: 0 3px 6px rgba(0,0,0,0.3);
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }
        
        .alert-new { 
            background: linear-gradient(135deg, #ef4444, #dc2626); 
            color: white; 
            animation: pulse 2s infinite;
        }
        
        .alert-stored { 
            background: linear-gradient(135deg, #6b7280, #4b5563); 
            color: white; 
        }
        
        .btn-gradient {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: all 0.3s ease;
            box-shadow: 0 6px 20px 0 rgba(102, 126, 234, 0.5);
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
            color: #ffffff !important;
            font-weight: 600;
        }
        
        .btn-gradient:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px 0 rgba(102, 126, 234, 0.7);
        }
        
        .btn-gradient:active {
            transform: translateY(0);
        }
        
        .card-gradient {
            background: linear-gradient(135deg, rgba(255,255,255,0.25) 0%, rgba(255,255,255,0.15) 100%);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255,255,255,0.35);
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
        }
        
        .live-indicator {
            width: 12px;
            height: 12px;
            background: #10b981;
            border-radius: 50%;
            animation: pulse 1s infinite;
            box-shadow: 0 0 15px #10b981;
        }
        
        .text-high-contrast {
            color: #ffffff !important;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
            font-weight: 600;
        }
        
        .text-card-contrast {
            color: #1f2937 !important;
            text-shadow: 0 1px 2px rgba(255,255,255,0.3);
            font-weight: 600;
        }
        
        .update-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            padding: 10px 18px;
            background: rgba(16, 185, 129, 0.95);
            color: white;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
            backdrop-filter: blur(10px);
            opacity: 0;
            transition: opacity 0.3s ease;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }
        
        .update-indicator.show {
            opacity: 1;
        }
        
        .chart-header {
            background: linear-gradient(90deg, rgba(102, 126, 234, 0.15) 0%, rgba(118, 75, 162, 0.15) 100%);
            border-radius: 12px 12px 0 0;
            padding: 14px 18px;
            border-bottom: 1px solid rgba(255,255,255,0.25);
        }
        
        .enhanced-btn {
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
            font-weight: 600;
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .alert-text {
            color: #ffffff !important;
            text-shadow: 0 1px 3px rgba(0,0,0,0.7);
            font-weight: 600;
        }

        /* PDF optimization */
        .container {
            max-width: none !important;
            width: 100% !important;
        }

        @media print {
            body {
                background: white !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            
            .glass-morphism {
                background: rgba(255, 255, 255, 0.95) !important;
                border: 1px solid rgba(0, 0, 0, 0.1) !important;
            }
            
            .text-high-contrast {
                color: #000000 !important;
            }
        }
    </style>
</head>
<body class="min-h-screen">
    <div class="update-indicator" id="update-indicator">
        <i class="fas fa-sync-alt mr-2"></i>Updating data...
    </div>
    
    <div class="container mx-auto p-2 sm:p-4 lg:p-6">
        <div class="glass-morphism rounded-2xl shadow-2xl p-4 sm:p-6 mb-6">
            <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-6 space-y-4 sm:space-y-0">
                <h1 class="text-2xl sm:text-3xl font-bold text-high-contrast flex items-center">
                    <div class="live-indicator mr-3"></div>
                    <i class="fas fa-chart-line text-yellow-300 mr-2"></i>
                    Enhanced Crypto Analyzer
                </h1>
                <div class="flex flex-col sm:flex-row items-start sm:items-center space-y-2 sm:space-y-0 sm:space-x-4 w-full sm:w-auto">
                    <select id="crypto-selector" class="w-full sm:w-auto glass-morphism text-high-contrast border-0 rounded-lg px-4 py-2 focus:ring-2 focus:ring-purple-400 appearance-none bg-opacity-20 enhanced-btn">
                        <option value="BTCUSDT">Bitcoin (BTC/USDT)</option>
                        <option value="ETHUSDT">Ethereum (ETH/USDT)</option>
                        <option value="SOLUSDT">Solana (SOL/USDT)</option>
                        <option value="BNBUSDT">Binance Coin (BNB/USDT)</option>
                        <option value="ADAUSDT">Cardano (ADA/USDT)</option>
                        <option value="XRPUSDT">XRP (XRP/USDT)</option>
                        <option value="LINKUSDT">Chainlink (LINK/USDT)</option>
                        <option value="UNIUSDT">Uniswap (UNI/USDT)</option>
                    </select>
                    <button id="clear-alerts-btn" class="w-full sm:w-auto bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition-all duration-300 flex items-center justify-center enhanced-btn">
                        <i class="fas fa-trash mr-2"></i>Clear Alerts
                    </button>
                </div>
            </div>

            <!-- Main Timeframe Selector -->
            <div class="mb-6">
                <h3 class="text-lg font-semibold mb-3 text-high-contrast flex items-center">
                    <i class="fas fa-clock text-blue-300 mr-2"></i>Display Timeframe
                </h3>
                <div id="timeframe-selector" class="flex flex-wrap gap-2">
                    <button class="timeframe-btn px-3 py-2 sm:px-4 glass-morphism text-high-contrast hover:bg-purple-500 rounded-lg transition-all duration-300 text-sm enhanced-btn" data-tf="1m">1M</button>
                    <button class="timeframe-btn px-3 py-2 sm:px-4 glass-morphism text-high-contrast hover:bg-purple-500 rounded-lg transition-all duration-300 text-sm enhanced-btn" data-tf="5m">5M</button>
                    <button class="timeframe-btn px-3 py-2 sm:px-4 glass-morphism text-high-contrast hover:bg-purple-500 rounded-lg transition-all duration-300 text-sm enhanced-btn" data-tf="10m">10M</button>
                    <button class="timeframe-btn px-3 py-2 sm:px-4 glass-morphism text-high-contrast hover:bg-purple-500 rounded-lg transition-all duration-300 text-sm enhanced-btn" data-tf="15m">15M</button>
                    <button class="timeframe-btn px-3 py-2 sm:px-4 glass-morphism text-high-contrast hover:bg-purple-500 rounded-lg transition-all duration-300 text-sm enhanced-btn" data-tf="30m">30M</button>
                    <button class="timeframe-btn px-3 py-2 sm:px-4 btn-gradient text-white rounded-lg active text-sm" data-tf="1h">1H</button>
                </div>
            </div>

            <!-- Multi-Timeframe Status -->
            <div class="mb-6 card-gradient p-4 rounded-xl">
                <h3 class="text-lg font-semibold mb-4 text-high-contrast flex items-center">
                    <i class="fas fa-layer-group text-purple-300 mr-2"></i>
                    Multi-Timeframe Analysis Status
                </h3>
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-3 sm:gap-4">
                    <div class="text-center">
                        <h4 class="font-medium text-xs sm:text-sm mb-2 text-high-contrast">1 Minute</h4>
                        <div class="space-y-1">
                            <div class="timeframe-status tf-loading" id="tf-1m-fast">Fast: --</div>
                            <div class="timeframe-status tf-loading" id="tf-1m-medium">Med: --</div>
                            <div class="timeframe-status tf-loading" id="tf-1m-slow">Slow: --</div>
                            <div class="timeframe-status tf-loading" id="tf-1m-full">Full: --</div>
                        </div>
                    </div>
                    <div class="text-center">
                        <h4 class="font-medium text-xs sm:text-sm mb-2 text-high-contrast">5 Minutes</h4>
                        <div class="space-y-1">
                            <div class="timeframe-status tf-loading" id="tf-5m-fast">Fast: --</div>
                            <div class="timeframe-status tf-loading" id="tf-5m-medium">Med: --</div>
                            <div class="timeframe-status tf-loading" id="tf-5m-slow">Slow: --</div>
                            <div class="timeframe-status tf-loading" id="tf-5m-full">Full: --</div>
                        </div>
                    </div>
                    <div class="text-center">
                        <h4 class="font-medium text-xs sm:text-sm mb-2 text-high-contrast">10 Minutes</h4>
                        <div class="space-y-1">
                            <div class="timeframe-status tf-loading" id="tf-10m-fast">Fast: --</div>
                            <div class="timeframe-status tf-loading" id="tf-10m-medium">Med: --</div>
                            <div class="timeframe-status tf-loading" id="tf-10m-slow">Slow: --</div>
                            <div class="timeframe-status tf-loading" id="tf-10m-full">Full: --</div>
                        </div>
                    </div>
                    <div class="text-center">
                        <h4 class="font-medium text-xs sm:text-sm mb-2 text-high-contrast">15 Minutes</h4>
                        <div class="space-y-1">
                            <div class="timeframe-status tf-loading" id="tf-15m-fast">Fast: --</div>
                            <div class="timeframe-status tf-loading" id="tf-15m-medium">Med: --</div>
                            <div class="timeframe-status tf-loading" id="tf-15m-slow">Slow: --</div>
                            <div class="timeframe-status tf-loading" id="tf-15m-full">Full: --</div>
                        </div>
                    </div>
                    <div class="text-center">
                        <h4 class="font-medium text-xs sm:text-sm mb-2 text-high-contrast">30 Minutes</h4>
                        <div class="space-y-1">
                            <div class="timeframe-status tf-loading" id="tf-30m-fast">Fast: --</div>
                            <div class="timeframe-status tf-loading" id="tf-30m-medium">Med: --</div>
                            <div class="timeframe-status tf-loading" id="tf-30m-slow">Slow: --</div>
                            <div class="timeframe-status tf-loading" id="tf-30m-full">Full: --</div>
                        </div>
                    </div>
                    <div class="text-center">
                        <h4 class="font-medium text-xs sm:text-sm mb-2 text-high-contrast">1 Hour</h4>
                        <div class="space-y-1">
                            <div class="timeframe-status tf-loading" id="tf-1h-fast">Fast: --</div>
                            <div class="timeframe-status tf-loading" id="tf-1h-medium">Med: --</div>
                            <div class="timeframe-status tf-loading" id="tf-1h-slow">Slow: --</div>
                            <div class="timeframe-status tf-loading" id="tf-1h-full">Full: --</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Indicator Controls -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-6">
                <div class="card-gradient p-4 rounded-xl">
                    <h3 class="text-lg font-semibold mb-3 text-high-contrast flex items-center">
                        <i class="fas fa-wave-square text-green-300 mr-2"></i>
                        Stochastic Indicators
                    </h3>
                    <div class="space-y-2">
                        <label class="flex items-center text-high-contrast cursor-pointer">
                            <input type="checkbox" id="stoch-fast-10-1-3" checked class="mr-2 accent-purple-500">
                            <span class="text-sm font-medium">Fast (10,1,3) - Red</span>
                        </label>
                        <label class="flex items-center text-high-contrast cursor-pointer">
                            <input type="checkbox" id="stoch-medium-14-1-3" checked class="mr-2 accent-purple-500">
                            <span class="text-sm font-medium">Medium (14,1,3) - Green</span>
                        </label>
                        <label class="flex items-center text-high-contrast cursor-pointer">
                            <input type="checkbox" id="stoch-slow-15-1-4" checked class="mr-2 accent-purple-500">
                            <span class="text-sm font-medium">Slow (15,1,4) - Blue</span>
                        </label>
                        <label class="flex items-center text-high-contrast cursor-pointer">
                            <input type="checkbox" id="stoch-full-34-2-1" checked class="mr-2 accent-purple-500">
                            <span class="text-sm font-medium">Full (34,2,1) - Purple</span>
                        </label>
                    </div>
                </div>
                
                <div class="card-gradient p-4 rounded-xl">
                    <h3 class="text-lg font-semibold mb-3 text-high-contrast flex items-center">
                        <i class="fas fa-chart-line text-orange-300 mr-2"></i>
                        EMA Lines
                    </h3>
                    <div class="flex flex-wrap gap-2">
                        <button class="toggle-btn ema-btn px-3 py-1 bg-orange-500 text-white rounded-lg active transition-all duration-300 text-sm enhanced-btn" data-ema="20">20 EMA</button>
                        <button class="toggle-btn ema-btn px-3 py-1 glass-morphism text-high-contrast rounded-lg transition-all duration-300 text-sm enhanced-btn" data-ema="50">50 EMA</button>
                        <button class="toggle-btn ema-btn px-3 py-1 glass-morphism text-high-contrast rounded-lg transition-all duration-300 text-sm enhanced-btn" data-ema="100">100 EMA</button>
                        <button class="toggle-btn ema-btn px-3 py-1 glass-morphism text-high-contrast rounded-lg transition-all duration-300 text-sm enhanced-btn" data-ema="200">200 EMA</button>
                    </div>
                </div>

                <div class="card-gradient p-4 rounded-xl">
                    <h3 class="text-lg font-semibold mb-3 text-high-contrast flex items-center">
                        <i class="fas fa-chart-bar text-blue-300 mr-2"></i>
                        Chart Type
                    </h3>
                    <div class="flex gap-2">
                        <button id="regular-candles" class="chart-type-btn px-3 py-1 btn-gradient text-white rounded-lg active transition-all duration-300 text-sm">Regular</button>
                        <button id="heikin-ashi" class="chart-type-btn px-3 py-1 glass-morphism text-high-contrast rounded-lg transition-all duration-300 text-sm enhanced-btn">Heikin Ashi</button>
                    </div>
                </div>
            </div>

            <!-- Split Charts Container -->
            <div class="space-y-4 mb-6">
                <!-- Price Chart -->
                <div class="chart-container relative">
                    <div class="chart-header">
                        <h3 class="text-lg font-semibold text-card-contrast flex items-center">
                            <i class="fas fa-chart-candlestick mr-2"></i>
                            Price Chart (Local Time)
                        </h3>
                    </div>
                    <div id="price-chart-container" class="w-full" style="height: 400px;">
                        <button id="restore-price-chart-btn" class="absolute top-16 left-4 bg-white bg-opacity-95 hover:bg-opacity-100 px-3 py-1 rounded-lg text-sm z-10 transition-all duration-300 shadow-lg text-card-contrast font-semibold">
                            <i class="fas fa-home mr-1"></i>Reset View
                        </button>
                    </div>
                </div>

                <!-- Stochastic Chart -->
                <div class="chart-container relative">
                    <div class="chart-header">
                        <h3 class="text-lg font-semibold text-card-contrast flex items-center">
                            <i class="fas fa-wave-square mr-2"></i>
                            Stochastic Oscillator (Local Time)
                        </h3>
                    </div>
                    <div id="stochastic-chart-container" class="w-full" style="height: 280px;">
                        <button id="restore-stochastic-chart-btn" class="absolute top-16 left-4 bg-white bg-opacity-95 hover:bg-opacity-100 px-3 py-1 rounded-lg text-sm z-10 transition-all duration-300 shadow-lg text-card-contrast font-semibold">
                            <i class="fas fa-home mr-1"></i>Reset View
                        </button>
                    </div>
                </div>
            </div>

            <!-- Trading Signals Dashboard -->
            <div class="grid grid-cols-1 xl:grid-cols-2 gap-6">
                <!-- Confluence Signal Conditions -->
                <div class="card-gradient rounded-xl p-4">
                    <h3 class="text-xl font-semibold mb-4 flex items-center text-high-contrast">
                        <i class="fas fa-layer-group text-purple-300 mr-2"></i>
                        Confluence Trading Signals
                    </h3>
                    
                    <!-- Basic Signals -->
                    <div class="mb-4 p-3 bg-blue-500 bg-opacity-30 rounded-lg backdrop-filter backdrop-blur-lg border border-blue-400 border-opacity-30">
                        <h4 class="font-semibold text-high-contrast mb-2 flex items-center">
                            <i class="fas fa-signal mr-2"></i>Basic Signals
                        </h4>
                        <div class="space-y-1 text-sm">
                            <div class="flex items-center text-high-contrast" id="basic-long-condition">
                                <i class="fas fa-circle text-gray-300 mr-2 condition-icon"></i>
                                <span class="font-medium">Long: All bands ≤ 15 (oversold)</span>
                            </div>
                            <div class="flex items-center text-high-contrast" id="basic-short-condition">
                                <i class="fas fa-circle text-gray-300 mr-2 condition-icon"></i>
                                <span class="font-medium">Short: All bands ≥ 90 (overbought)</span>
                            </div>
                        </div>
                    </div>

                    <!-- Confluence Levels -->
                    <div class="space-y-3">
                        <div class="p-3 bg-purple-500 bg-opacity-30 rounded-lg backdrop-filter backdrop-blur-lg border border-purple-400 border-opacity-30">
                            <h4 class="font-semibold text-high-contrast mb-2">Confluence Level 1 (1m + 5m)</h4>
                            <div class="flex items-center text-high-contrast" id="confluence-1-condition">
                                <i class="fas fa-circle text-gray-300 mr-2 condition-icon"></i>
                                <span class="text-sm font-medium">Both timeframes aligned</span>
                            </div>
                        </div>
                        
                        <div class="p-3 bg-purple-500 bg-opacity-30 rounded-lg backdrop-filter backdrop-blur-lg border border-purple-400 border-opacity-30">
                            <h4 class="font-semibold text-high-contrast mb-2">Confluence Level 2 (1m + 5m + 10m)</h4>
                            <div class="flex items-center text-high-contrast" id="confluence-2-condition">
                                <i class="fas fa-circle text-gray-300 mr-2 condition-icon"></i>
                                <span class="text-sm font-medium">Three timeframes aligned</span>
                            </div>
                        </div>
                        
                        <div class="p-3 bg-purple-500 bg-opacity-30 rounded-lg backdrop-filter backdrop-blur-lg border border-purple-400 border-opacity-30">
                            <h4 class="font-semibold text-high-contrast mb-2">Confluence Level 3 (1m + 5m + 10m + 15m)</h4>
                            <div class="flex items-center text-high-contrast" id="confluence-3-condition">
                                <i class="fas fa-circle text-gray-300 mr-2 condition-icon"></i>
                                <span class="text-sm font-medium">Four timeframes aligned</span>
                            </div>
                        </div>
                        
                        <div class="p-3 bg-purple-500 bg-opacity-30 rounded-lg backdrop-filter backdrop-blur-lg border border-purple-400 border-opacity-30">
                            <h4 class="font-semibold text-high-contrast mb-2">Confluence Level 4 (1m + 5m + 10m + 15m + 30m)</h4>
                            <div class="flex items-center text-high-contrast" id="confluence-4-condition">
                                <i class="fas fa-circle text-gray-300 mr-2 condition-icon"></i>
                                <span class="text-sm font-medium">Five timeframes aligned</span>
                            </div>
                        </div>
                        
                        <div class="p-3 bg-purple-500 bg-opacity-30 rounded-lg backdrop-filter backdrop-blur-lg border border-purple-400 border-opacity-30">
                            <h4 class="font-semibold text-high-contrast mb-2">Confluence Level 5 (All Timeframes)</h4>
                            <div class="flex items-center text-high-contrast" id="confluence-5-condition">
                                <i class="fas fa-circle text-gray-300 mr-2 condition-icon"></i>
                                <span class="text-sm font-medium">All six timeframes aligned</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Enhanced Alerts Panel -->
                <div class="card-gradient rounded-xl p-4">
                    <h3 class="text-xl font-semibold mb-4 flex items-center text-high-contrast">
                        <i class="fas fa-bell text-red-400 mr-2"></i>
                        Live Confluence Alerts
                        <span id="stored-alert-count" class="alert-badge alert-stored ml-2">0 Stored</span>
                    </h3>
                    <div id="alerts-container" class="alert-container space-y-2">
                        <div class="p-3 bg-blue-500 bg-opacity-30 border-l-4 border-blue-400 rounded backdrop-filter backdrop-blur-lg">
                            <div class="flex items-center">
                                <i class="fas fa-info-circle text-blue-400 mr-2"></i>
                                <span class="text-sm alert-text">
                                    [<span id="initial-timestamp"></span>] Enhanced multi-timeframe confluence system initialized (Local Time)...
                                </span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Current Confluence Status -->
                    <div class="mt-4 p-3 bg-gray-500 bg-opacity-30 rounded-lg backdrop-filter backdrop-blur-lg border border-gray-400 border-opacity-30">
                        <h4 class="font-semibold mb-2 text-high-contrast">Current Status</h4>
                        <div class="text-sm space-y-1 text-high-contrast">
                            <div>Active Confluence Level: <span id="current-confluence-level" class="font-bold text-yellow-300">0</span></div>
                            <div>Last Signal: <span id="last-signal-type" class="font-bold text-yellow-300">None</span></div>
                            <div>Signal Strength: <span id="signal-strength" class="font-bold text-yellow-300">Weak</span></div>
                            <div>Alerts Stored: <span id="alert-count-display" class="font-bold text-yellow-300">0/10</span></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let priceChart;
        let stochasticChart;
        let candleSeries;
        let stochasticSeries = {};
        let backgroundSeries = {};
        let currentTimeframe = '1h';
        let currentSymbol = 'BTCUSDT';
        let updateInterval;
        let lastAlertTime = 0;
        let isHeikinAshi = false;
        let isUpdating = false;
        
        // Multi-timeframe data storage
        let multitimeframeData = {
            '1m': { stochastics: {}, lastUpdate: 0 },
            '5m': { stochastics: {}, lastUpdate: 0 },
            '10m': { stochastics: {}, lastUpdate: 0 },
            '15m': { stochastics: {}, lastUpdate: 0 },
            '30m': { stochastics: {}, lastUpdate: 0 },
            '1h': { stochastics: {}, lastUpdate: 0 }
        };
        
        // Alert storage
        let alertHistory = [];
        let timeframeAlertStates = {};
        
        // EMA series
        let emaSeries = {
            '20': null,
            '50': null,
            '100': null,
            '200': null
        };
        
        // Current display data
        let currentCandles = [];
        let currentHeikinAshi = [];
        
        // Stochastic colors
        const stochColors = {
            'fast': { color: '#EF4444', label: 'Fast (10,1,3)' },
            'medium': { color: '#10B981', label: 'Medium (14,1,3)' },
            'slow': { color: '#3B82F6', label: 'Slow (15,1,4)' },
            'full': { color: '#8B5CF6', label: 'Full (34,2,1)' }
        };

        // Previous stochastic data for anti-flicker comparison
        let previousStochasticData = {};

        // Store current visible time ranges
        let currentVisibleTimeRange = null;

        function showUpdateIndicator() {
            const indicator = document.getElementById('update-indicator');
            indicator.classList.add('show');
            setTimeout(() => {
                indicator.classList.remove('show');
            }, 1000);
        }

        function convertToLocalTime(utcTimestamp) {
            return Math.floor(utcTimestamp / 1000);
        }

        function loadStoredAlerts() {
            try {
                const stored = localStorage.getItem('cryptoAnalyzerAlerts');
                if (stored) {
                    alertHistory = JSON.parse(stored);
                    updateAlertCount();
                    displayStoredAlerts();
                }
            } catch (error) {
                console.error('Error loading stored alerts:', error);
                alertHistory = [];
            }
        }

        function saveAlert(alert) {
            alertHistory.unshift(alert);
            if (alertHistory.length > 10) {
                alertHistory = alertHistory.slice(0, 10);
            }
            
            try {
                localStorage.setItem('cryptoAnalyzerAlerts', JSON.stringify(alertHistory));
                updateAlertCount();
            } catch (error) {
                console.error('Error saving alert:', error);
            }
        }

        function clearStoredAlerts() {
            alertHistory = [];
            localStorage.removeItem('cryptoAnalyzerAlerts');
            updateAlertCount();
            
            const alertsContainer = document.getElementById('alerts-container');
            while (alertsContainer.children.length > 1) {
                alertsContainer.removeChild(alertsContainer.children[1]);
            }
        }

        function updateAlertCount() {
            const count = alertHistory.length;
            document.getElementById('stored-alert-count').textContent = `${count} Stored`;
            document.getElementById('alert-count-display').textContent = `${count}/10`;
        }

        function displayStoredAlerts() {
            alertHistory.forEach(alert => {
                addAlertToUI(alert.message, alert.type, alert.signalType, alert.timestamp, true);
            });
        }

        function initCharts() {
            if (isUpdating) return;
            
            const priceContainer = document.getElementById('price-chart-container');
            const stochasticContainer = document.getElementById('stochastic-chart-container');
            
            if (!priceChart) {
                priceContainer.innerHTML = '<button id="restore-price-chart-btn" class="absolute top-16 left-4 bg-white bg-opacity-95 hover:bg-opacity-100 px-3 py-1 rounded-lg text-sm z-10 transition-all duration-300 shadow-lg text-card-contrast font-semibold"><i class="fas fa-home mr-1"></i>Reset View</button>';
                stochasticContainer.innerHTML = '<button id="restore-stochastic-chart-btn" class="absolute top-16 left-4 bg-white bg-opacity-95 hover:bg-opacity-100 px-3 py-1 rounded-lg text-sm z-10 transition-all duration-300 shadow-lg text-card-contrast font-semibold"><i class="fas fa-home mr-1"></i>Reset View</button>';
            }

            if (!priceChart) {
                priceChart = LightweightCharts.createChart(priceContainer, {
                    layout: {
                        backgroundColor: '#ffffff',
                        textColor: '#1f2937',
                        fontSize: 12,
                        fontFamily: 'Inter, sans-serif'
                    },
                    grid: {
                        vertLines: { color: '#e5e7eb' },
                        horzLines: { color: '#e5e7eb' },
                    },
                    width: priceContainer.clientWidth,
                    height: priceContainer.clientHeight,
                    timeScale: {
                        rightOffset: 0,
                        barSpacing: 6,
                        fixLeftEdge: false,
                        fixRightEdge: true,
                        lockVisibleTimeRangeOnResize: true,
                        timeVisible: true,
                        secondsVisible: true,
                        shiftVisibleRangeOnNewBar: true
                    },
                    localization: {
                        timeFormatter: (time) => {
                            const date = new Date(time * 1000);
                            return date.toLocaleString([], { 
                                hour: '2-digit', 
                                minute: '2-digit',
                                month: '2-digit',
                                day: '2-digit',
                                hour12: false
                            });
                        }
                    }
                });
            }

            if (!stochasticChart) {
                stochasticChart = LightweightCharts.createChart(stochasticContainer, {
                    layout: {
                        backgroundColor: '#ffffff',
                        textColor: '#1f2937',
                        fontSize: 12,
                        fontFamily: 'Inter, sans-serif'
                    },
                    grid: {
                        vertLines: { color: '#e5e7eb' },
                        horzLines: { color: '#e5e7eb' },
                    },
                    width: stochasticContainer.clientWidth,
                    height: stochasticContainer.clientHeight,
                    rightPriceScale: {
                        scaleMargins: {
                            top: 0.1,
                            bottom: 0.1,
                        },
                        borderVisible: false,
                    },
                    timeScale: {
                        rightOffset: 0,
                        barSpacing: 6,
                        fixLeftEdge: false,
                        fixRightEdge: true,
                        lockVisibleTimeRangeOnResize: true,
                        timeVisible: true,
                        secondsVisible: true,
                        shiftVisibleRangeOnNewBar: true
                    },
                    localization: {
                        timeFormatter: (time) => {
                            const date = new Date(time * 1000);
                            return date.toLocaleString([], { 
                                hour: '2-digit', 
                                minute: '2-digit',
                                month: '2-digit',
                                day: '2-digit',
                                hour12: false
                            });
                        }
                    }
                });
            }

            if (!candleSeries) {
                candleSeries = priceChart.addCandlestickSeries({
                    upColor: '#10b981',
                    downColor: '#ef4444',
                    borderVisible: false,
                    wickUpColor: '#10b981',
                    wickDownColor: '#ef4444'
                });
            }
            
            if (Object.keys(backgroundSeries).length === 0) {
                createStochasticBackgrounds();
            }
            
            if (Object.keys(stochasticSeries).length === 0) {
                Object.keys(stochColors).forEach(key => {
                    stochasticSeries[key] = stochasticChart.addLineSeries({
                        color: stochColors[key].color,
                        lineWidth: 3,
                        lineStyle: 0,
                        priceLineVisible: false,
                        lastValueVisible: false,
                        crosshairMarkerVisible: false
                    });
                });

                const upperLine = stochasticChart.addLineSeries({
                    color: '#DC2626',
                    lineWidth: 2,
                    lineStyle: 2,
                    priceLineVisible: false,
                    lastValueVisible: false,
                    crosshairMarkerVisible: false
                });
                
                const lowerLine = stochasticChart.addLineSeries({
                    color: '#059669',
                    lineWidth: 2,
                    lineStyle: 2,
                    priceLineVisible: false,
                    lastValueVisible: false,
                    crosshairMarkerVisible: false
                });

                const now = Math.floor(Date.now() / 1000);
                const pastTime = now - 86400 * 30;
                const futureTime = now + 86400 * 30;
                upperLine.setData([
                    { time: pastTime, value: 90 },
                    { time: futureTime, value: 90 }
                ]);
                lowerLine.setData([
                    { time: pastTime, value: 15 },
                    { time: futureTime, value: 15 }
                ]);
            }

            if (priceChart && stochasticChart) {
                priceChart.timeScale().subscribeVisibleTimeRangeChange(() => {
                    const timeRange = priceChart.timeScale().getVisibleRange();
                    if (timeRange && !isUpdating) {
                        currentVisibleTimeRange = timeRange;
                        stochasticChart.timeScale().setVisibleRange(timeRange);
                    }
                });

                stochasticChart.timeScale().subscribeVisibleTimeRangeChange(() => {
                    const timeRange = stochasticChart.timeScale().getVisibleRange();
                    if (timeRange && !isUpdating) {
                        currentVisibleTimeRange = timeRange;
                        priceChart.timeScale().setVisibleRange(timeRange);
                    }
                });
            }

            loadStoredAlerts();
            loadMultitimeframeData();
            setupAutoUpdate();
            setupIndicatorControls();
            
            document.getElementById('restore-price-chart-btn').addEventListener('click', () => {
                priceChart.timeScale().fitContent();
            });
            
            document.getElementById('restore-stochastic-chart-btn').addEventListener('click', () => {
                stochasticChart.timeScale().fitContent();
            });
            
            document.getElementById('initial-timestamp').textContent = new Date().toLocaleString();
        }
        
        function createStochasticBackgrounds() {
            backgroundSeries.overbought = stochasticChart.addAreaSeries({
                topColor: 'rgba(239, 68, 68, 0.15)',
                bottomColor: 'rgba(239, 68, 68, 0.08)',
                lineColor: 'transparent',
                lineWidth: 0,
                priceLineVisible: false,
                lastValueVisible: false,
                crosshairMarkerVisible: false
            });
            
            backgroundSeries.neutral = stochasticChart.addAreaSeries({
                topColor: 'rgba(156, 163, 175, 0.06)',
                bottomColor: 'rgba(156, 163, 175, 0.03)',
                lineColor: 'transparent',
                lineWidth: 0,
                priceLineVisible: false,
                lastValueVisible: false,
                crosshairMarkerVisible: false
            });
            
            backgroundSeries.oversold = stochasticChart.addAreaSeries({
                topColor: 'rgba(16, 185, 129, 0.15)',
                bottomColor: 'rgba(16, 185, 129, 0.08)',
                lineColor: 'transparent',
                lineWidth: 0,
                priceLineVisible: false,
                lastValueVisible: false,
                crosshairMarkerVisible: false
            });
        }
        
        function updateStochasticBackgrounds(timeData) {
            if (!timeData || timeData.length === 0) return;
            
            const now = Math.floor(Date.now() / 1000);
            const pastTime = now - 86400 * 30;
            const futureTime = now + 86400 * 30;
            
            if (backgroundSeries.overbought) {
                backgroundSeries.overbought.setData([
                    { time: pastTime, value: 100 },
                    { time: futureTime, value: 90 }
                ]);
            }
            
            if (backgroundSeries.neutral) {
                backgroundSeries.neutral.setData([
                    { time: pastTime, value: 90 },
                    { time: futureTime, value: 15 }
                ]);
            }
            
            if (backgroundSeries.oversold) {
                backgroundSeries.oversold.setData([
                    { time: pastTime, value: 15 },
                    { time: futureTime, value: 0 }
                ]);
            }
        }

        function calculateHeikinAshi(candles) {
            const heikinAshi = [];
            
            for (let i = 0; i < candles.length; i++) {
                const current = candles[i];
                let ha = { time: current.time };
                
                if (i === 0) {
                    ha.open = (current.open + current.close) / 2;
                    ha.close = (current.open + current.high + current.low + current.close) / 4;
                    ha.high = current.high;
                    ha.low = current.low;
                } else {
                    const prev = heikinAshi[i - 1];
                    ha.open = (prev.open + prev.close) / 2;
                    ha.close = (current.open + current.high + current.low + current.close) / 4;
                    ha.high = Math.max(current.high, ha.open, ha.close);
                    ha.low = Math.min(current.low, ha.open, ha.close);
                }
                
                heikinAshi.push(ha);
            }
            
            return heikinAshi;
        }

        function calculateStochastic(candles, kPeriod = 14, smoothK = 1, dPeriod = 3) {
            const result = [];
            const kValues = [];
            const smoothedKValues = [];

            for (let i = 0; i < candles.length; i++) {
                if (i < kPeriod - 1) {
                    result.push({ time: candles[i].time, k: null, d: null });
                    continue;
                }

                let low = Infinity;
                let high = -Infinity;

                for (let j = i - kPeriod + 1; j <= i; j++) {
                    low = Math.min(low, candles[j].low);
                    high = Math.max(high, candles[j].high);
                }

                const currentClose = candles[i].close;
                const k = ((currentClose - low) / (high - low)) * 100;
                kValues.push(k);
                
                let smoothedK = k;
                if (smoothK > 1) {
                    if (kValues.length >= smoothK) {
                        const kSlice = kValues.slice(-smoothK);
                        smoothedK = kSlice.reduce((sum, val) => sum + val, 0) / smoothK;
                    } else {
                        smoothedK = null;
                    }
                }
                
                if (smoothedK !== null) {
                    smoothedKValues.push(smoothedK);
                }

                let d = null;
                if (smoothedKValues.length >= dPeriod && smoothedK !== null) {
                    const dSlice = smoothedKValues.slice(-dPeriod);
                    d = dSlice.reduce((sum, val) => sum + val, 0) / dPeriod;
                }

                result.push({
                    time: candles[i].time,
                    k: smoothedK,
                    d: d,
                });
            }

            return result;
        }
        
        function calculateEMA(data, period, priceKey = 'close') {
            const k = 2 / (period + 1);
            const ema = [];
            
            let sum = 0;
            for (let i = 0; i < period && i < data.length; i++) {
                sum += data[i][priceKey];
                ema.push({ time: data[i].time, value: null });
            }
            
            if (data.length >= period) {
                ema[period-1] = { time: data[period-1].time, value: sum / period };
                
                for (let i = period; i < data.length; i++) {
                    const value = data[i][priceKey] * k + ema[i-1].value * (1 - k);
                    ema.push({ time: data[i].time, value: value });
                }
            }
            
            return ema;
        }

        // Anti-flicker stochastic data comparison
        function hasStochasticChanged(timeframe, newData) {
            const prevKey = `${currentSymbol}_${timeframe}`;
            const prevData = previousStochasticData[prevKey];
            
            if (!prevData) {
                previousStochasticData[prevKey] = JSON.stringify(newData);
                return true;
            }
            
            const newDataString = JSON.stringify(newData);
            if (prevData !== newDataString) {
                previousStochasticData[prevKey] = newDataString;
                return true;
            }
            
            return false;
        }

        async function loadTimeframeData(timeframe) {
            try {
                let candles;
                let stochastics;

                if (timeframe === '10m') {
                    const limit = 400;
                    const response = await fetch(`https://api.binance.com/api/v3/klines?symbol=${currentSymbol}&interval=5m&limit=${limit}`);
                    const data = await response.json();

                    candles = [];
                    for (let i = 0; i < data.length - 1; i += 2) {
                        const candle1 = data[i];
                        const candle2 = data[i + 1];
                        if (!candle2) break;

                        candles.push({
                            time: convertToLocalTime(candle1[0]),
                            open: parseFloat(candle1[1]),
                            high: Math.max(parseFloat(candle1[2]), parseFloat(candle2[2])),
                            low: Math.min(parseFloat(candle1[3]), parseFloat(candle2[3])),
                            close: parseFloat(candle2[4]),
                            volume: parseFloat(candle1[5]) + parseFloat(candle2[5])
                        });
                    }
                } else {
                    const limit = ['1m', '5m'].includes(timeframe) ? 200 : 150;
                    const response = await fetch(`https://api.binance.com/api/v3/klines?symbol=${currentSymbol}&interval=${timeframe}&limit=${limit}`);
                    const data = await response.json();

                    candles = data.map(d => ({
                        time: convertToLocalTime(d[0]),
                        open: parseFloat(d[1]),
                        high: parseFloat(d[2]),
                        low: parseFloat(d[3]),
                        close: parseFloat(d[4]),
                        volume: parseFloat(d[5])
                    }));
                }

                stochastics = {
                    fast: calculateStochastic(candles, 10, 1, 3),
                    medium: calculateStochastic(candles, 14, 1, 3),
                    slow: calculateStochastic(candles, 15, 1, 4),
                    full: calculateStochastic(candles, 34, 2, 1)
                };

                multitimeframeData[timeframe] = {
                    candles: candles,
                    stochastics: stochastics,
                    lastUpdate: Date.now()
                };

                updateTimeframeStatus(timeframe, stochastics);
                checkTimeframeAlerts(timeframe, stochastics);
                
                return { candles, stochastics };
            } catch (error) {
                console.error(`Error loading ${timeframe} data:`, error);
                return null;
            }
        }
        
        function checkTimeframeAlerts(timeframe, stochastics) {
            const keys = ['fast', 'medium', 'slow', 'full'];
            const latest = {};
            
            keys.forEach(key => {
                const stochData = stochastics[key];
                latest[key] = stochData.length > 0 ? stochData[stochData.length - 1].d : null;
            });
            
            const allValid = Object.values(latest).every(val => val !== null && !isNaN(val));
            if (!allValid) return;
            
            const allOversold = Object.values(latest).every(val => val <= 15);
            const allOverbought = Object.values(latest).every(val => val >= 90);
            
            const alertKey = `${currentSymbol}_${timeframe}`;
            const previousState = timeframeAlertStates[alertKey];
            
            if (allOversold && previousState !== 'oversold') {
                timeframeAlertStates[alertKey] = 'oversold';
                const valuesStr = keys.map(key => `${key}: ${Math.round(latest[key])}`).join(', ');
                const message = `🟢 ${timeframe.toUpperCase()} OVERSOLD ALERT: All stochastics ≤15 (${valuesStr}) - Potential LONG setup for ${currentSymbol}`;
                addAlert(message, 'bullish', 'timeframe');
            } else if (allOverbought && previousState !== 'overbought') {
                timeframeAlertStates[alertKey] = 'overbought';
                const valuesStr = keys.map(key => `${key}: ${Math.round(latest[key])}`).join(', ');
                const message = `🔴 ${timeframe.toUpperCase()} OVERBOUGHT ALERT: All stochastics ≥90 (${valuesStr}) - Potential SHORT setup for ${currentSymbol}`;
                addAlert(message, 'bearish', 'timeframe');
            } else if (!allOversold && !allOverbought && previousState) {
                timeframeAlertStates[alertKey] = null;
            }
        }
        
        function updateTimeframeStatus(timeframe, stochastics) {
            const keys = ['fast', 'medium', 'slow', 'full'];
            keys.forEach(key => {
                const element = document.getElementById(`tf-${timeframe}-${key}`);
                if (element && stochastics[key].length > 0) {
                    const latestValue = stochastics[key][stochastics[key].length - 1].d;
                    if (latestValue !== null) {
                        const roundedValue = Math.round(latestValue);
                        element.textContent = `${key === 'medium' ? 'Med' : key.charAt(0).toUpperCase() + key.slice(1)}: ${roundedValue}`;
                        
                        element.className = 'timeframe-status';
                        if (roundedValue <= 15) {
                            element.classList.add('tf-oversold');
                        } else if (roundedValue >= 90) {
                            element.classList.add('tf-overbought');
                        } else {
                            element.classList.add('tf-neutral');
                        }
                    }
                }
            });
        }
        
        async function loadMultitimeframeData() {
            if (isUpdating) return;
            isUpdating = true;
            
            showUpdateIndicator();
            const timeframes = ['1m', '5m', '10m', '15m', '30m', '1h'];
            
            try {
                // Store current visible range before updating
                const currentVisibleRange = priceChart.timeScale().getVisibleRange();
                
                const promises = timeframes.map(tf => loadTimeframeData(tf));
                await Promise.all(promises);
                
                const displayData = multitimeframeData[currentTimeframe];
                if (displayData && displayData.candles) {
                    currentCandles = displayData.candles;
                    currentHeikinAshi = calculateHeikinAshi(currentCandles);
                    
                    const chartData = isHeikinAshi ? currentHeikinAshi : currentCandles;
                    if (candleSeries) {
                        candleSeries.setData(chartData);
                    }
                    
                    // Anti-flicker stochastic update - only update if data actually changed
                    if (hasStochasticChanged(currentTimeframe, displayData.stochastics)) {
                        Object.keys(stochasticSeries).forEach(key => {
                            if (displayData.stochastics[key] && stochasticSeries[key]) {
                                const data = displayData.stochastics[key]
                                    .filter(d => d.d !== null)
                                    .map(d => ({ time: d.time, value: d.d }));
                                stochasticSeries[key].setData(data);
                            }
                        });
                        
                        updateStochasticBackgrounds(displayData.stochastics.medium);
                    }
                    
                    updateEMAs();
                }
                
                // Restore the visible range after updating data
                if (currentVisibleRange) {
                    priceChart.timeScale().setVisibleRange(currentVisibleRange);
                    stochasticChart.timeScale().setVisibleRange(currentVisibleRange);
                }
                
                analyzeConfluence();
                
            } finally {
                isUpdating = false;
            }
        }
        
        function updateEMAs() {
            Object.keys(emaSeries).forEach(period => {
                const btn = document.querySelector(`.ema-btn[data-ema="${period}"]`);
                if (btn && btn.classList.contains('active')) {
                    if (!emaSeries[period]) {
                        emaSeries[period] = priceChart.addLineSeries({
                            color: getEMAColor(period),
                            lineWidth: 2,
                            title: `${period} EMA`,
                        });
                    }
                    const emaData = calculateEMA(currentCandles, parseInt(period));
                    emaSeries[period].setData(emaData);
                } else if (emaSeries[period]) {
                    priceChart.removeSeries(emaSeries[period]);
                    emaSeries[period] = null;
                }
            });
        }
        
        function getEMAColor(period) {
            const colors = {
                '20': '#F97316',
                '50': '#3B82F6',
                '100': '#10B981',
                '200': '#8B5CF6'
            };
            return colors[period] || '#333';
        }
        
        function addAlert(message, type, signalType = '') {
            const now = Date.now();
            if (now - lastAlertTime < 3000 && type !== 'info') return;
            
            lastAlertTime = now;
            
            const alert = {
                timestamp: new Date().toLocaleTimeString(),
                message: message,
                type: type,
                signalType: signalType,
                symbol: currentSymbol,
                time: now
            };
            
            saveAlert(alert);
            addAlertToUI(message, type, signalType, alert.timestamp, false);
        }
        
        function addAlertToUI(message, type, signalType, timestamp, isStored) {
            const alertsContainer = document.getElementById('alerts-container');
            const alertDiv = document.createElement('div');
            
            let alertClass = 'p-3 rounded border-l-4 backdrop-filter backdrop-blur-lg ';
            let iconClass = 'fas fa-info-circle ';
            
            switch(type) {
                case 'bullish':
                    if (signalType === 'confluence') {
                        alertClass += 'confluence-signal';
                    } else if (signalType === 'timeframe') {
                        alertClass += 'timeframe-alert';
                    } else {
                        alertClass += 'long-signal';
                    }
                    iconClass = 'fas fa-arrow-up text-green-400 ';
                    break;
                case 'bearish':
                    if (signalType === 'confluence') {
                        alertClass += 'confluence-signal';
                    } else if (signalType === 'timeframe') {
                        alertClass += 'timeframe-alert';
                    } else {
                        alertClass += 'short-signal';
                    }
                    iconClass = 'fas fa-arrow-down text-red-400 ';
                    break;
                default:
                    alertClass += 'bg-blue-500 bg-opacity-30 border-blue-400';
                    iconClass = 'fas fa-info-circle text-blue-400 ';
            }
            
            alertDiv.className = alertClass;
            
            const badgeClass = isStored ? 'alert-stored' : 'alert-new';
            const badgeText = isStored ? 'STORED' : 'NEW';
            
            alertDiv.innerHTML = `
                <div class="flex items-center">
                    <i class="${iconClass}mr-2"></i>
                    <span class="text-sm font-semibold alert-text">
                        [${timestamp}] ${message}
                    </span>
                    <span class="alert-badge ${badgeClass}">${badgeText}</span>
                </div>
            `;
            
            alertsContainer.insertBefore(alertDiv, alertsContainer.children[1]);
            
            while (alertsContainer.children.length > 21) {
                alertsContainer.removeChild(alertsContainer.lastChild);
            }
        }
        
        function updateConditionStatus(conditionId, isActive) {
            const element = document.getElementById(conditionId);
            if (!element) return;
            
            const icon = element.querySelector('.condition-icon');
            if (isActive) {
                icon.className = 'fas fa-check-circle text-green-400 mr-2 condition-icon signal-indicator';
            } else {
                icon.className = 'fas fa-circle text-gray-300 mr-2 condition-icon';
            }
        }
        
        function checkTimeframeCondition(timeframe) {
            const data = multitimeframeData[timeframe];
            if (!data || !data.stochastics) return { oversold: false, overbought: false };
            
            const stochs = data.stochastics;
            const latest = {
                fast: stochs.fast.length > 0 ? stochs.fast[stochs.fast.length - 1].d : null,
                medium: stochs.medium.length > 0 ? stochs.medium[stochs.medium.length - 1].d : null,
                slow: stochs.slow.length > 0 ? stochs.slow[stochs.slow.length - 1].d : null,
                full: stochs.full.length > 0 ? stochs.full[stochs.full.length - 1].d : null
            };
            
            const allOversold = latest.fast !== null && latest.medium !== null && latest.slow !== null && latest.full !== null &&
                               latest.fast <= 15 && latest.medium <= 15 && latest.slow <= 15 && latest.full <= 15;
            const allOverbought = latest.fast !== null && latest.medium !== null && latest.slow !== null && latest.full !== null &&
                                 latest.fast >= 90 && latest.medium >= 90 && latest.slow >= 90 && latest.full >= 90;
            
            return { oversold: allOversold, overbought: allOverbought };
        }
        
        function analyzeConfluence() {
            const timeframes = ['1m', '5m', '10m', '15m', '30m', '1h'];
            const confluenceGroups = [
                ['1m', '5m'],
                ['1m', '5m', '10m'],
                ['1m', '5m', '10m', '15m'],
                ['1m', '5m', '10m', '15m', '30m'],
                ['1m', '5m', '10m', '15m', '30m', '1h']
            ];
            
            const currentCondition = checkTimeframeCondition(currentTimeframe);
            updateConditionStatus('basic-long-condition', currentCondition.oversold);
            updateConditionStatus('basic-short-condition', currentCondition.overbought);
            
            let maxConfluenceLevel = 0;
            let confluenceType = 'none';
            
            confluenceGroups.forEach((group, index) => {
                const level = index + 1;
                
                const oversoldCount = group.filter(tf => checkTimeframeCondition(tf).oversold).length;
                const overboughtCount = group.filter(tf => checkTimeframeCondition(tf).overbought).length;
                
                const isOversoldConfluence = oversoldCount === group.length;
                const isOverboughtConfluence = overboughtCount === group.length;
                
                const hasConfluence = isOversoldConfluence || isOverboughtConfluence;
                updateConditionStatus(`confluence-${level}-condition`, hasConfluence);
                
                if (hasConfluence) {
                    maxConfluenceLevel = level;
                    confluenceType = isOversoldConfluence ? 'long' : 'short';
                    
                    const direction = isOversoldConfluence ? 'LONG' : 'SHORT';
                    const condition = isOversoldConfluence ? 'oversold (≤15)' : 'overbought (≥90)';
                    addAlert(
                        `⚡ CONFLUENCE LEVEL ${level} ${direction}: All stochastic bands ${condition} across ${group.join(', ')} timeframes - Strong ${direction.toLowerCase()} signal for ${currentSymbol}!`,
                        isOversoldConfluence ? 'bullish' : 'bearish',
                        'confluence'
                    );
                }
            });
            
            document.getElementById('current-confluence-level').textContent = maxConfluenceLevel;
            document.getElementById('last-signal-type').textContent = confluenceType === 'none' ? 'None' : confluenceType.toUpperCase();
            
            let quality = 'Weak';
            if (maxConfluenceLevel >= 4) quality = 'Very Strong';
            else if (maxConfluenceLevel >= 3) quality = 'Strong';
            else if (maxConfluenceLevel >= 2) quality = 'Moderate';
            else if (maxConfluenceLevel >= 1) quality = 'Fair';
            
            document.getElementById('signal-strength').textContent = quality;
        }
        
        function setupIndicatorControls() {
            ['fast-10-1-3', 'medium-14-1-3', 'slow-15-1-4', 'full-34-2-1'].forEach(id => {
                document.getElementById(`stoch-${id}`).addEventListener('change', function() {
                    let actualKey;
                    if (id.includes('10-1-3')) actualKey = 'fast';
                    else if (id.includes('14-1-3')) actualKey = 'medium';
                    else if (id.includes('15-1-4')) actualKey = 'slow';
                    else if (id.includes('34-2-1')) actualKey = 'full';
                    
                    if (stochasticSeries[actualKey]) {
                        stochasticSeries[actualKey].applyOptions({ visible: this.checked });
                    }
                });
            });
            
            document.querySelectorAll('.ema-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    this.classList.toggle('active');
                    if (this.classList.contains('active')) {
                        this.classList.remove('glass-morphism');
                        this.classList.add('btn-gradient');
                    } else {
                        this.classList.remove('btn-gradient');
                        this.classList.add('glass-morphism');
                    }
                    updateEMAs();
                });
            });

            document.getElementById('regular-candles').addEventListener('click', function() {
                if (!this.classList.contains('active')) {
                    isHeikinAshi = false;
                    this.classList.add('active', 'btn-gradient');
                    this.classList.remove('glass-morphism');
                    document.getElementById('heikin-ashi').classList.remove('active', 'btn-gradient');
                    document.getElementById('heikin-ashi').classList.add('glass-morphism');
                    
                    if (currentCandles.length > 0 && candleSeries) {
                        candleSeries.setData(currentCandles);
                    }
                }
            });

            document.getElementById('heikin-ashi').addEventListener('click', function() {
                if (!this.classList.contains('active')) {
                    isHeikinAshi = true;
                    this.classList.add('active', 'btn-gradient');
                    this.classList.remove('glass-morphism');
                    document.getElementById('regular-candles').classList.remove('active', 'btn-gradient');
                    document.getElementById('regular-candles').classList.add('glass-morphism');
                    
                    if (currentHeikinAshi.length > 0 && candleSeries) {
                        candleSeries.setData(currentHeikinAshi);
                    }
                }
            });

            document.getElementById('clear-alerts-btn').addEventListener('click', function() {
                if (confirm('Are you sure you want to clear all stored alerts?')) {
                    clearStoredAlerts();
                }
            });
        }

        function setupAutoUpdate() {
            if (updateInterval) clearInterval(updateInterval);
            
            updateInterval = setInterval(() => {
                if (!isUpdating) {
                    loadMultitimeframeData();
                }
            }, 3000);
        }

        document.querySelectorAll('.timeframe-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.timeframe-btn').forEach(b => {
                    b.classList.remove('active', 'btn-gradient');
                    b.classList.add('glass-morphism');
                });
                this.classList.add('active', 'btn-gradient');
                this.classList.remove('glass-morphism');
                currentTimeframe = this.dataset.tf;
                loadMultitimeframeData();
            });
        });

        document.getElementById('crypto-selector').addEventListener('change', function() {
            currentSymbol = this.value;
            timeframeAlertStates = {};
            previousStochasticData = {}; // Reset anti-flicker data
            
            if (priceChart) {
                priceChart.remove();
                priceChart = null;
            }
            if (stochasticChart) {
                stochasticChart.remove();
                stochasticChart = null;
            }
            
            candleSeries = null;
            stochasticSeries = {};
            backgroundSeries = {};
            emaSeries = {
                '20': null,
                '50': null,
                '100': null,
                '200': null
            };
            
            initCharts();
        });

        window.addEventListener('resize', function() {
            if (priceChart && !isUpdating) {
                priceChart.applyOptions({ 
                    width: document.getElementById('price-chart-container').clientWidth,
                    height: document.getElementById('price-chart-container').clientHeight
                });
            }
            if (stochasticChart && !isUpdating) {
                stochasticChart.applyOptions({ 
                    width: document.getElementById('stochastic-chart-container').clientWidth,
                    height: document.getElementById('stochastic-chart-container').clientHeight
                });
            }
        });

        initCharts();
    </script>
</body>
</html>
